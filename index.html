
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The New Collective</title>

    <!-- 1. THE ENGINE ROOM (Libraries) - ORDER IS CRITICAL -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React must load BEFORE Lucide -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (UMD) -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

    <!-- 2. THE NETWORK (Firebase Module Loader) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase to the global window object for the React app
        window.FB = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc
        };
    </script>

    <!-- 3. THE CAMOUFLAGE (PWA Manifest Injection) -->
    <script>
        const manifest = {
            "name": "The New Collective",
            "short_name": "Collective",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#10b981",
            "icons": [{ "src": "https://placehold.co/192x192/10b981/ffffff?text=NC", "sizes": "192x192", "type": "image/png" }]
        };
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
        document.head.appendChild(link);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #0f172a;
        }
        .dark-glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Safe Area Padding */
        .pb-safe { padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen pb-safe">

    <!-- THE REACT ROOT -->
    <div id="root"></div>

    <!-- THE LOGIC -->
    <script type="text/babel">
        // --- GLOBAL DEPENDENCIES ---
        const { useState, useEffect, useMemo } = window.React;
        // Lucide icons are exposed via the global object (handling UMD quirks)
        const lucide = window.lucideReact || window.lucide; 
        const { Users, Trophy, TrendingUp, ShoppingCart, Package, Truck, AlertTriangle, Loader2, CheckCircle, MapPin, DollarSign, Trash2, Shield, X, Info } = lucide.icons;

        // --- CONFIGURATION ---
        // ðŸš¨ PASTE YOUR FIREBASE CONFIG HERE ðŸš¨
        const DEFAULT_CONFIG = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const APP_ID = "YOUR_PROJECT_ID"; // Usually same as projectId
        
        const LOGISTICS_SURCHARGE = 150.00;
        const ZONES = ['Diepkloof', 'Orlando', 'Pimville', 'Dobsonville', 'Meadowlands', 'Zola'];
        
        // THE BLACK BOX DATA (LBC LOCKED)
        const TARGETS = {
            'Ace Maize Meal (10kg)': { target: 150, unit: 'bags', base_price: 90.00, factory_discount: 0.25, user_discount: 0.125 },
            'Tastic Rice (10kg Bag)': { target: 60, unit: 'bags', base_price: 256.00, factory_discount: 0.30, user_discount: 0.15 },
            'Golden Cloud Flour (12.5kg)': { target: 75, unit: 'bags', base_price: 110.00, factory_discount: 0.22, user_discount: 0.11 },
            'Sugar (10kg Bag)': { target: 120, unit: 'bags', base_price: 92.00, factory_discount: 0.20, user_discount: 0.10 },
            'Coca-Cola (2L Case)': { target: 100, unit: 'cases', base_price: 110.00, factory_discount: 0.28, user_discount: 0.14 },
            'Cooking Oil (2L)': { target: 80, unit: 'bottles', base_price: 75.00, factory_discount: 0.25, user_discount: 0.12 },
            'Terminate Bleach (5x750ml)': { target: 50, unit: 'units', base_price: 76.00, factory_discount: 0.20, user_discount: 0.10 }
        };
        const PRODUCT_NAMES = Object.keys(TARGETS);

        // --- UTILS ---
        const formatRands = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return 'R0.00';
            return new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR', minimumFractionDigits: 2 }).format(amount);
        };

        const timeAgo = (timestamp) => {
            if (!timestamp || !timestamp.seconds) return '...';
            const diff = Math.floor((Date.now() - timestamp.seconds * 1000) / 1000);
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
            return new Date(timestamp.seconds * 1000).toLocaleDateString();
        };

        // --- MAIN COMPONENT ---
        const App = () => {
            // System State
            const [system, setSystem] = useState({ status: 'booting', error: null });
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            
            // UI State
            const [tab, setTab] = useState('commit'); // commit | ledger
            const [loading, setLoading] = useState(false);
            const [showModal, setShowModal] = useState(false); // { title, message, isError, isSuccess }

            // Form State
            const [form, setForm] = useState({
                shopName: '',
                zone: ZONES[0],
                item: PRODUCT_NAMES[0],
                qty: ''
            });

            // 1. BOOT STRATEGY
            useEffect(() => {
                const init = async () => {
                    let attempts = 0;
                    while (!window.FB && attempts < 20) { await new Promise(r => setTimeout(r, 200)); attempts++; }
                    
                    if (!window.FB) {
                        setSystem({ status: 'error', error: 'Network Protocol Failed. Refresh.' });
                        return;
                    }

                    try {
                        const FB = window.FB;
                        const app = FB.initializeApp(DEFAULT_CONFIG);
                        const auth = FB.getAuth(app);
                        const db = FB.getFirestore(app);
                        
                        // Silent Auth
                        await FB.signInAnonymously(auth);

                        FB.onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setSystem({ status: 'ready', db, auth });
                                
                                // Real-time Listener
                                const q = FB.query(
                                    FB.collection(db, 'artifacts', APP_ID, 'public', 'data', 'collective_orders'), 
                                    FB.orderBy('createdAt', 'desc')
                                );
                                
                                FB.onSnapshot(q, snap => {
                                    setOrders(snap.docs.map(d => ({id: d.id, ...d.data()})));
                                });
                            }
                        });
                    } catch (e) {
                        console.error(e);
                        setSystem({ status: 'error', error: 'Initialization Failed. Check Config.' });
                    }
                };
                init();
            }, []);

            // 2. METRICS & AGGREGATION
            const metrics = useMemo(() => {
                const item = TARGETS[form.item];
                const qty = parseInt(form.qty) || 0;
                if (qty <= 0 || !item) return { valid: false };

                const gross = item.base_price * qty;
                const savings = gross * item.user_discount;
                const net = gross - savings;
                const final = net + LOGISTICS_SURCHARGE;
                const revenue = (gross * item.factory_discount) - savings;

                return { gross, savings, net, final, revenue, valid: true };
            }, [form.item, form.qty]);

            const { stats, leaderboard, totalSavings, totalValue } = useMemo(() => {
                const data = JSON.parse(JSON.stringify(TARGETS));
                Object.keys(data).forEach(k => data[k].current = 0);
                const zones = {};
                ZONES.forEach(z => zones[z] = 0);
                let sav = 0;
                let val = 0;

                orders.forEach(o => {
                    if (data[o.item]) data[o.item].current += (o.qty || 0);
                    if (o.zone) zones[o.zone] += (o.qty || 0);
                    if (o.value_savings) sav += o.value_savings;
                    if (o.value_final) val += o.value_final;
                });

                return {
                    stats: Object.entries(data).map(([k, v]) => ({
                        name: k, ...v,
                        pct: Math.min((v.current / v.target) * 100, 100),
                        unlocked: v.current >= v.target
                    })),
                    leaderboard: Object.entries(zones).sort((a,b) => b[1] - a[1]),
                    totalSavings: sav,
                    totalValue: val
                };
            }, [orders]);

            // 3. HANDLERS
            const commit = async (e) => {
                e.preventDefault();
                if (!metrics.valid || !form.shopName) return;
                setLoading(true);
                
                try {
                    const FB = window.FB;
                    await FB.addDoc(FB.collection(system.db, 'artifacts', APP_ID, 'public', 'data', 'collective_orders'), {
                        userId: user.uid,
                        shopName: form.shopName,
                        zone: form.zone,
                        item: form.item,
                        qty: parseInt(form.qty),
                        value_gross: metrics.gross,
                        value_savings: metrics.savings,
                        value_net: metrics.net,
                        value_revenue: metrics.revenue,
                        value_final: metrics.final,
                        createdAt: FB.serverTimestamp()
                    });
                    setForm(p => ({ ...p, qty: '' }));
                    setShowModal({ title: "Success", message: "Order committed to the Ledger.", isSuccess: true });
                } catch (err) {
                    setShowModal({ title: "Error", message: err.message, isError: true });
                }
                setLoading(false);
            };

            const deleteOrder = async (id, ownerId) => {
                if (user.uid !== ownerId) return;
                try {
                    const FB = window.FB;
                    await FB.deleteDoc(FB.doc(system.db, 'artifacts', APP_ID, 'public', 'data', 'collective_orders', id));
                } catch (e) { console.error(e); }
            };

            // 4. RENDER
            if (system.status === 'booting') return (
                <div className="fixed inset-0 flex flex-col items-center justify-center bg-slate-900 text-emerald-500">
                    <Loader2 className="w-16 h-16 animate-spin mb-4" />
                    <div className="font-mono text-xs tracking-widest uppercase">Initializing Protocol...</div>
                </div>
            );

            if (system.status === 'error') return (
                <div className="fixed inset-0 flex items-center justify-center bg-red-950 text-red-200 p-8 text-center">
                    <AlertTriangle className="w-12 h-12 mx-auto mb-4" />
                    <h2 className="text-xl font-bold mb-2">System Failure</h2>
                    <p className="text-sm font-mono">{system.error}</p>
                </div>
            );

            return (
                <div className="max-w-md mx-auto bg-slate-900 min-h-screen shadow-2xl pb-20">
                    {/* HEADER */}
                    <div className="dark-glass sticky top-0 z-50 border-b border-slate-800 p-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-lg font-black text-white tracking-tight flex items-center gap-2">
                                <Users className="text-emerald-500" size={20} /> THE NEW COLLECTIVE
                            </h1>
                            <p className="text-[10px] text-slate-400 font-mono uppercase tracking-widest">Supply Network V4.1</p>
                        </div>
                        <div className="bg-emerald-500/10 border border-emerald-500/20 rounded px-2 py-1">
                            <div className="text-[9px] text-emerald-400 font-mono">ID: {user?.uid.substring(0,4)}..</div>
                        </div>
                    </div>

                    <main className="p-4 space-y-6">
                        {/* TOTALS DASHBOARD (New 0-to-1 Focus) */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1"><DollarSign size={12}/> Savings</div>
                                <div className="text-2xl font-black text-emerald-400 truncate">{formatRands(totalSavings)}</div>
                            </div>
                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1"><TrendingUp size={12}/> Volume</div>
                                <div className="text-2xl font-black text-white truncate">{formatRands(totalValue)}</div>
                            </div>
                        </div>

                        {/* ZONE LEADERBOARD */}
                        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><Trophy size={14} className="text-amber-400"/> Zone Power</h2>
                            <div className="flex gap-3 overflow-x-auto pb-2">
                                {leaderboard.map(([zone, val], i) => (
                                    <div key={zone} className={`flex-shrink-0 p-3 rounded-lg border min-w-[100px] text-center ${i===0 ? 'bg-amber-400/10 border-amber-400 text-amber-300' : 'bg-slate-800 border-slate-700'}`}>
                                        <div className="text-[10px] font-mono tracking-widest">{i===0?'LEADER':`#${i+1}`}</div>
                                        <div className="font-bold truncate">{zone}</div>
                                        <div className="text-xs font-mono">{val} UNITS</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* TABS */}
                        <div className="grid grid-cols-2 gap-1 bg-slate-800 p-1 rounded-lg">
                            <button onClick={() => setTab('commit')} className={`py-2 text-sm font-bold rounded transition-all ${tab==='commit' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400'}`}>Commit Order</button>
                            <button onClick={() => setTab('ledger')} className={`py-2 text-sm font-bold rounded transition-all ${tab==='ledger' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400'}`}>Ledger</button>
                        </div>

                        {/* COMMIT FORM */}
                        {tab === 'commit' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="space-y-2">
                                    {stats.map(s => (
                                        <div key={s.name} className="bg-slate-800 p-3 rounded-lg border border-slate-700 relative overflow-hidden">
                                            <div className="flex justify-between text-sm relative z-10">
                                                <span className="font-medium text-slate-200">{s.name}</span>
                                                <span className={s.unlocked ? "text-emerald-400 font-bold" : "text-slate-500"}>{s.current}/{s.target}</span>
                                            </div>
                                            <div className="h-1 bg-slate-700 mt-2 rounded-full relative z-10"><div className={`h-full transition-all duration-1000 ${s.unlocked ? 'bg-emerald-500' : 'bg-blue-600'}`} style={{width: `${s.pct}%`}}></div></div>
                                        </div>
                                    ))}
                                </div>

                                <form onSubmit={commit} className="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-xl">
                                    <div className="space-y-4">
                                        <div><label className="text-xs font-bold text-slate-500 uppercase">Shop Name</label><input value={form.shopName} onChange={e=>setForm({...form, shopName:e.target.value})} className="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 ring-emerald-500 outline-none" required/></div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Zone</label><select value={form.zone} onChange={e=>setForm({...form, zone:e.target.value})} className="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg text-white outline-none">{ZONES.map(z=><option key={z} value={z}>{z}</option>)}</select></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Qty</label><input type="number" min="1" value={form.qty} onChange={e=>setForm({...form, qty:e.target.value})} className="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 ring-emerald-500 outline-none" required/></div>
                                        </div>
                                        <div><label className="text-xs font-bold text-slate-500 uppercase">Item</label><select value={form.item} onChange={e=>setForm({...form, item:e.target.value})} className="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg text-white outline-none">{PRODUCT_NAMES.map(n=><option key={n} value={n}>{n}</option>)}</select></div>
                                    </div>

                                    {metrics.valid && (
                                        <div className="mt-6 bg-slate-900/50 rounded-lg p-4 border border-slate-600">
                                            <div className="flex justify-between text-slate-400 text-sm"><span>Wholesale Value</span><span>{formatRands(metrics.gross)}</span></div>
                                            <div className="flex justify-between text-emerald-400 text-sm font-bold"><span>Collective Savings</span><span>-{formatRands(metrics.savings)}</span></div>
                                            <div className="flex justify-between text-blue-400 text-sm pt-2 border-t border-slate-700 mt-1"><span>Logistics Fee</span><span>+{formatRands(LOGISTICS_SURCHARGE)}</span></div>
                                            <div className="flex justify-between text-white text-xl font-black pt-2 mt-2 border-t border-slate-700"><span>TOTAL DUE</span><span className="text-emerald-400">{formatRands(metrics.final)}</span></div>
                                        </div>
                                    )}

                                    <button disabled={loading || !metrics.valid} className="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-500/20 active:scale-[0.98] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2">
                                        {loading ? <Loader2 className="animate-spin"/> : <ShoppingCart size={20} />}
                                        {loading ? 'COMMITTING...' : 'CONFIRM ORDER'}
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* LEDGER VIEW */}
                        {tab === 'ledger' && (
                            <div className="space-y-3 animate-fade-in">
                                {orders.length === 0 ? <div className="text-center py-12 opacity-30"><Package size={48} className="mx-auto mb-2"/><p>Ledger Empty</p></div> : 
                                orders.slice(0, 10).map(o => (
                                    <div key={o.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                                        <div>
                                            <div className="font-bold text-white">{o.shopName}</div>
                                            <div className="text-xs text-slate-400">{o.qty}x {o.item}</div>
                                            <div className="text-[10px] text-emerald-500 mt-1 font-mono uppercase">{o.zone}</div>
                                        </div>
                                        <div className="text-right ml-4">
                                            <div className="text-sm font-bold text-white">{formatRands(o.value_final)}</div>
                                            <div className="text-[10px] text-slate-500">{timeAgo(o.createdAt)}</div>
                                            {o.userId === user.uid && <button onClick={() => deleteOrder(o.id, o.userId)} className="mt-1 text-red-400 hover:text-red-300"><Trash2 size={14}/></button>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                         <div className="text-center pt-8 pb-8">
                            <button onClick={() => setShowModal({ title: "Report Failure", message: "Log a supply issue.", isError: false, isSuccess: false })} className="text-xs text-slate-600 hover:text-red-400 transition-colors flex items-center justify-center gap-1 mx-auto">
                                <AlertTriangle size={12}/> Report Failure
                            </button>
                        </div>
                    </main>

                    {/* MODAL */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                            <div className={`w-full max-w-xs rounded-2xl p-6 shadow-2xl ${showModal.isError ? 'bg-red-900 border-red-700' : showModal.isSuccess ? 'bg-emerald-900 border-emerald-700' : 'bg-slate-800 border-slate-700'}`}>
                                <h3 className="font-bold text-lg text-white mb-2 flex items-center gap-2">
                                    {showModal.isError ? <AlertTriangle size={20}/> : <Info size={20}/>} {showModal.title}
                                </h3>
                                <p className="text-sm mb-4 text-slate-300">{showModal.message}</p>
                                <button onClick={() => setShowModal(false)} className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-lg text-white font-bold">Close</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- LAUNCH ---
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (e) {
            document.body.innerHTML = `<div style="color:red;padding:20px">CRITICAL: ${e.message}</div>`;
        }
    </script>
</body>
</html>


