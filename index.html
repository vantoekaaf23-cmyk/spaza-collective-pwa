<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The New Collective</title>

    <!-- 1. THE ENGINE ROOM (Libraries) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

    <!-- 2. THE NETWORK (Firebase Module Loader) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.FB = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc
        };
    </script>

    <!-- 3. THE CAMOUFLAGE (PWA Manifest Injection) -->
    <script>
        const manifest = {
            "name": "The New Collective",
            "short_name": "Collective",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#10b981",
            "icons": [{ "src": "https://placehold.co/192x192/10b981/ffffff?text=NC", "sizes": "192x192", "type": "image/png" }]
        };
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
        document.head.appendChild(link);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .dark-glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .animate-pulse-fast { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen pb-safe">

    <!-- THE REACT ROOT -->
    <div id="root"></div>

    <!-- THE LOGIC -->
    <script type="text/babel">
        // --- CONFIGURATION ---
        // REPLACE THIS WITH YOUR FIREBASE CONFIG FROM THE CONSOLE IF NEEDED
        const DEFAULT_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const LOGISTICS_SURCHARGE = 150.00;
        const ZONES = ['Diepkloof', 'Orlando', 'Pimville', 'Dobsonville', 'Meadowlands', 'Zola'];
        
        // THE BLACK BOX DATA (LBC LOCKED)
        const TARGETS = {
            'Ace Maize Meal (10kg)': { target: 150, unit: 'bags', base_price: 90.00, factory_discount: 0.25, user_discount: 0.125 },
            'Tastic Rice (10kg Bag)': { target: 60, unit: 'bags', base_price: 256.00, factory_discount: 0.30, user_discount: 0.15 },
            'Golden Cloud Flour (12.5kg)': { target: 75, unit: 'bags', base_price: 110.00, factory_discount: 0.22, user_discount: 0.11 },
            'Sugar (10kg Bag)': { target: 120, unit: 'bags', base_price: 92.00, factory_discount: 0.20, user_discount: 0.10 },
            'Coca-Cola (2L Case)': { target: 100, unit: 'cases', base_price: 110.00, factory_discount: 0.28, user_discount: 0.14 },
            'Cooking Oil (2L)': { target: 80, unit: 'bottles', base_price: 75.00, factory_discount: 0.25, user_discount: 0.12 },
            'Terminate Bleach (5x750ml)': { target: 50, unit: 'units', base_price: 76.00, factory_discount: 0.20, user_discount: 0.10 }
        };

        const { useState, useEffect, useMemo } = React;
        const { Users, Trophy, TrendingUp, ShoppingCart, Package, Truck, AlertTriangle, Loader2, CheckCircle, MapPin, DollarSign, Trash2, Shield } = lucide;

        // --- MAIN COMPONENT ---
        const App = () => {
            const [system, setSystem] = useState({ status: 'booting', error: null });
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            
            // UX State
            const [tab, setTab] = useState('commit');
            const [loading, setLoading] = useState(false);
            const [showModal, setShowModal] = useState(false);

            // Form State
            const [form, setForm] = useState({
                shopName: '',
                zone: ZONES[0],
                item: Object.keys(TARGETS)[0],
                qty: ''
            });

            // --- BOOT STRATEGY ---
            useEffect(() => {
                const init = async () => {
                    let attempts = 0;
                    while (!window.FB && attempts < 20) {
                        await new Promise(r => setTimeout(r, 200));
                        attempts++;
                    }
                    
                    if (!window.FB) {
                        setSystem({ status: 'error', error: 'Network Protocol Failed. Refresh.' });
                        return;
                    }

                    try {
                        const FB = window.FB;
                        // Robust Config Handling
                        let config = DEFAULT_CONFIG;
                        if (Object.keys(config).length === 0) {
                            // Fallback for GitHub Pages (You must fill this in later via Secrets or manual edit if needed)
                            console.warn("No Firebase Config Found. App will stall.");
                        }

                        const app = FB.initializeApp(config);
                        const auth = FB.getAuth(app);
                        const db = FB.getFirestore(app);

                        // Silent Auth
                        await FB.signInAnonymously(auth);

                        FB.onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setSystem({ status: 'ready' });
                                
                                // Real-time Link
                                const q = FB.query(
                                    FB.collection(db, 'artifacts', APP_ID, 'public', 'data', 'collective_orders'), 
                                    FB.orderBy('createdAt', 'desc')
                                );
                                
                                FB.onSnapshot(q, snap => {
                                    setOrders(snap.docs.map(d => ({id: d.id, ...d.data()})));
                                });
                            }
                        });
                    } catch (e) {
                        console.error(e);
                        setSystem({ status: 'error', error: 'Security Handshake Failed.' });
                    }
                };
                init();
            }, []);

            // --- THE BLACK BOX LOGIC ---
            const metrics = useMemo(() => {
                const item = TARGETS[form.item];
                const qty = parseInt(form.qty) || 0;
                
                const gross = item.base_price * qty;
                const savings = gross * item.user_discount;
                const net = gross - savings;
                const final = net + LOGISTICS_SURCHARGE;
                
                // THE HIDDEN PROFIT
                const revenue = (gross * item.factory_discount) - savings;

                return { gross, savings, net, final, revenue, valid: qty > 0 };
            }, [form.item, form.qty]);

            // --- AGGREGATION ENGINE ---
            const stats = useMemo(() => {
                const data = JSON.parse(JSON.stringify(TARGETS));
                Object.keys(data).forEach(k => data[k].current = 0);
                orders.forEach(o => { if(data[o.item]) data[o.item].current += o.qty; });
                
                return Object.entries(data).map(([k, v]) => ({
                    name: k, ...v,
                    pct: Math.min((v.current / v.target) * 100, 100),
                    unlocked: v.current >= v.target
                }));
            }, [orders]);

            const leaderboard = useMemo(() => {
                const z = {};
                ZONES.forEach(n => z[n] = 0);
                orders.forEach(o => { if(o.zone) z[o.zone] += o.qty; });
                return Object.entries(z).sort((a,b) => b[1] - a[1]);
            }, [orders]);

            // --- ACTION HANDLERS ---
            const commit = async (e) => {
                e.preventDefault();
                if (!metrics.valid || !form.shopName) return;
                setLoading(true);
                
                try {
                    const FB = window.FB;
                    const db = FB.getFirestore();
                    
                    await FB.addDoc(FB.collection(db, 'artifacts', APP_ID, 'public', 'data', 'collective_orders'), {
                        userId: user.uid,
                        shopName: form.shopName,
                        zone: form.zone,
                        item: form.item,
                        qty: parseInt(form.qty),
                        // FINANCIAL RECORD
                        value_gross: metrics.gross,
                        value_savings: metrics.savings,
                        value_net: metrics.net,
                        value_revenue: metrics.revenue, // HIDDEN
                        value_final: metrics.final,
                        createdAt: FB.serverTimestamp()
                    });
                    
                    setForm(p => ({ ...p, qty: '' }));
                } catch (err) {
                    alert("Commitment Error: " + err.message);
                }
                setLoading(false);
            };

            // --- FORMATTING ---
            const money = (n) => new Intl.NumberFormat('en-ZA', {style: 'currency', currency: 'ZAR'}).format(n);

            // --- RENDERER ---
            if (system.status === 'booting') return (
                <div className="fixed inset-0 flex flex-col items-center justify-center bg-slate-900 text-emerald-500">
                    <Loader2 className="w-16 h-16 animate-spin mb-4" />
                    <div className="font-mono text-xs tracking-widest uppercase">Establishing Secure Link...</div>
                </div>
            );

            if (system.status === 'error') return (
                <div className="fixed inset-0 flex items-center justify-center bg-red-950 text-red-200 p-8 text-center">
                    <div>
                        <AlertTriangle className="w-12 h-12 mx-auto mb-4" />
                        <h2 className="text-xl font-bold mb-2">System Lockout</h2>
                        <p className="text-sm font-mono">{system.error}</p>
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto bg-slate-900 min-h-screen shadow-2xl overflow-hidden">
                    
                    {/* NAV BAR */}
                    <div className="dark-glass sticky top-0 z-50 border-b border-slate-800 p-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-lg font-black text-white tracking-tight flex items-center gap-2">
                                <Users className="text-emerald-500" size={20} /> THE NEW COLLECTIVE
                            </h1>
                            <p className="text-[10px] text-slate-400 font-mono uppercase tracking-widest">Supply Network V3.0</p>
                        </div>
                        <div className="bg-emerald-500/10 border border-emerald-500/20 rounded px-2 py-1 text-right">
                            <div className="text-[10px] text-emerald-400 font-bold flex items-center gap-1">
                                <Shield size={10} /> SECURE
                            </div>
                        </div>
                    </div>

                    <div className="p-4 space-y-6">
                        
                        {/* ZONE WARFARE */}
                        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <div className="flex items-center justify-between mb-3">
                                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                    <Trophy size={14} className="text-amber-400"/> Zone Power
                                </h2>
                            </div>
                            <div className="flex gap-3 overflow-x-auto pb-2">
                                {leaderboard.map(([zone, score], i) => (
                                    <div key={zone} className="flex-shrink-0 bg-slate-800 p-3 rounded-lg border border-slate-700 min-w-[100px] text-center">
                                        <div className="text-[10px] text-slate-500 font-mono">RANK #{i+1}</div>
                                        <div className="font-bold text-white truncate">{zone}</div>
                                        <div className="text-xs text-emerald-400 font-mono">{score} UNITS</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* TABS */}
                        <div className="grid grid-cols-2 gap-1 bg-slate-800 p-1 rounded-lg">
                            <button onClick={() => setTab('commit')} className={`py-2.5 text-sm font-bold rounded-md transition-all ${tab === 'commit' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                Commit Order
                            </button>
                            <button onClick={() => setTab('ledger')} className={`py-2.5 text-sm font-bold rounded-md transition-all ${tab === 'ledger' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                Live Ledger
                            </button>
                        </div>

                        {/* COMMIT VIEW */}
                        {tab === 'commit' && (
                            <div className="space-y-6 animate-fade-in">
                                <!-- TARGETS DASHBOARD -->
                                <div className="space-y-3">
                                    {stats.map(s => (
                                        <div key={s.name} className="bg-slate-800 p-3 rounded-lg border border-slate-700 relative overflow-hidden">
                                            <div className="flex justify-between text-sm relative z-10">
                                                <span className="font-medium text-slate-200">{s.name}</span>
                                                <span className={s.unlocked ? "text-emerald-400 font-bold" : "text-slate-500 font-mono"}>
                                                    {s.current}/{s.target}
                                                </span>
                                            </div>
                                            <div className="h-1 bg-slate-700 mt-2 rounded-full overflow-hidden relative z-10">
                                                <div className={`h-full transition-all duration-1000 ${s.unlocked ? 'bg-emerald-500' : 'bg-blue-500'}`} style={{width: `${s.pct}%`}}></div>
                                            </div>
                                            {s.unlocked && <div className="absolute right-2 top-2 opacity-10 rotate-12"><CheckCircle size={64} /></div>}
                                        </div>
                                    ))}
                                </div>

                                <!-- ORDER FORM -->
                                <form onSubmit={commit} className="bg-white rounded-xl p-5 text-slate-900 shadow-xl">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Shop Name</label>
                                            <input 
                                                value={form.shopName} 
                                                onChange={e => setForm({...form, shopName: e.target.value})}
                                                className="w-full p-3 bg-slate-100 border-0 rounded-lg font-semibold focus:ring-2 ring-emerald-500 outline-none" 
                                                placeholder="e.g. Mama's Store"
                                                required
                                            />
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase">Zone</label>
                                                <select 
                                                    value={form.zone}
                                                    onChange={e => setForm({...form, zone: e.target.value})}
                                                    className="w-full p-3 bg-slate-100 border-0 rounded-lg font-semibold outline-none"
                                                >
                                                    {ZONES.map(z => <option key={z} value={z}>{z}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase">Quantity</label>
                                                <input 
                                                    type="number" 
                                                    value={form.qty}
                                                    onChange={e => setForm({...form, qty: e.target.value})}
                                                    className="w-full p-3 bg-slate-100 border-0 rounded-lg font-semibold focus:ring-2 ring-emerald-500 outline-none" 
                                                    placeholder="0"
                                                    min="1"
                                                    required
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Item</label>
                                            <select 
                                                value={form.item}
                                                onChange={e => setForm({...form, item: e.target.value})}
                                                className="w-full p-3 bg-slate-100 border-0 rounded-lg font-semibold outline-none"
                                            >
                                                {Object.keys(TARGETS).map(t => <option key={t} value={t}>{t}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    {/* THE BREAKDOWN */}
                                    {metrics.valid && (
                                        <div className="mt-6 bg-slate-50 rounded-lg p-4 border border-slate-200">
                                            <div className="flex justify-between text-slate-500 text-sm mb-1">
                                                <span>Wholesale Value</span>
                                                <span>{money(metrics.gross)}</span>
                                            </div>
                                            <div className="flex justify-between text-emerald-600 text-sm font-bold mb-2">
                                                <span>Collective Savings</span>
                                                <span>-{money(metrics.savings)}</span>
                                            </div>
                                            <div className="border-t border-slate-200 my-2"></div>
                                            <div className="flex justify-between text-blue-600 text-sm font-medium">
                                                <span className="flex items-center gap-1"><Truck size={12}/> Logistics Fee</span>
                                                <span>{money(LOGISTICS_SURCHARGE)}</span>
                                            </div>
                                            <div className="flex justify-between text-slate-900 text-xl font-black mt-2 pt-2 border-t border-slate-300">
                                                <span>TOTAL</span>
                                                <span>{money(metrics.final)}</span>
                                            </div>
                                        </div>
                                    )}

                                    <button 
                                        disabled={loading || !metrics.valid}
                                        className="w-full mt-4 bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-500/30 active:scale-[0.98] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2"
                                    >
                                        {loading ? <Loader2 className="animate-spin"/> : <ShoppingCart size={20} />}
                                        {loading ? 'Committing...' : 'COMMIT ORDER'}
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* LEDGER VIEW */}
                        {tab === 'ledger' && (
                            <div className="space-y-3 animate-fade-in">
                                {orders.length === 0 ? (
                                    <div className="text-center py-12 opacity-30">
                                        <Package size={48} className="mx-auto mb-2"/>
                                        <p>Ledger Empty</p>
                                    </div>
                                ) : (
                                    orders.map(o => (
                                        <div key={o.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-white">{o.shopName}</div>
                                                <div className="text-xs text-slate-400">{o.qty}x {o.item}</div>
                                                <div className="text-[10px] text-emerald-500 mt-1 font-mono uppercase">{o.zone}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-sm font-bold text-white">{money(o.value_final)}</div>
                                                <div className="text-[10px] text-slate-500">{new Date(o.createdAt?.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        <div className="text-center pt-8 pb-8">
                            <button onClick={() => setShowModal(true)} className="text-xs text-slate-600 hover:text-red-400 transition-colors flex items-center justify-center gap-1 mx-auto">
                                <AlertTriangle size={12}/> Report Failure
                            </button>
                        </div>

                    </main>

                    {/* MODAL */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                            <div className="bg-slate-800 w-full max-w-xs rounded-2xl p-6 border border-slate-700">
                                <h3 className="font-bold text-lg text-white mb-2">Report Failure</h3>
                                <textarea className="w-full bg-slate-900 border-slate-600 text-white rounded-lg p-3 text-sm h-24 mb-4" placeholder="Describe issue..."></textarea>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowModal(false)} className="flex-1 py-3 text-slate-400 font-bold bg-slate-700 rounded-lg">Cancel</button>
                                    <button onClick={() => setShowModal(false)} className="flex-1 py-3 text-white font-bold bg-red-600 rounded-lg">Log</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


